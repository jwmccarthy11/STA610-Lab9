---
title: "Lab 9"
author: 
  -  Emily Gentles
  -  Weiyi Liu
  -  Jack McCarthy
  -  Qinzhe Wang
date: "10/28/2021"
output: pdf_document
---


## Introduction

This lab aims to examine the factors related to presence of badger activity in the farmyard, and the correlation over time in badger activity and farm-specific heterogeneity in the tendency to have badger activity.

```{r setup, include=FALSE}
library(tidyverse)
library(lme4)
library(janitor)
library(reshape2)
library(kableExtra)
library(caret)
library(lattice)
library(gridExtra)

knitr::opts_chunk$set(
  echo=FALSE,
  message=FALSE,
  warning=FALSE
)
```

```{r}
data <- read.table('BadgersFarmSurveysNoNA.txt', header=TRUE) %>%
  janitor::clean_names() %>%
  rename(no_cattle_in_buildings_yard=no_cattle_in_buidlings_yard)
```

# EDA

### Reponse: Signs_in_yard

First a look at the distribution of the response. We can look at the mean 
__signs_in_yard__ value for each farm to get a "rate" of signs being observed.

```{r, fig.height=4}
data %>%
  group_by(farm_code_numeric) %>%
  summarise(
    n=n(),
    signs_rate=mean(signs_in_yard)
  ) %>%
  ggplot(aes(x=reorder(farm_code_numeric, -signs_rate), y=signs_rate)) +
    geom_bar(stat='identity', color='black', fill='lightcoral') +
    geom_text(aes(label=n), vjust=-0.25) +
    labs(x='Farm Code', y='Observed Signs Rate (w/ Sample Size)') +
    scale_x_discrete(guide=guide_axis(angle=45)) +
    theme_bw()
```

It seems like the signs rates vary widely across farms, so we should expect to 
see heterogeneity in our final model. Now we can look at the signs rates for 
some of the candidate predictors. First, a look at the rates for each value of 
the number of active badger settlements.

```{r, fig.height=3.5}
data %>%
  group_by(no_active_setts_in_fields) %>%
  summarise(
    n=n(),
    signs_rate=mean(signs_in_yard)
  ) %>%
  ggplot(aes(x=no_active_setts_in_fields, y=signs_rate)) +
    geom_bar(stat='identity', color='black', fill='lightblue') +
    geom_text(aes(label=n), vjust=-0.25) +
    scale_x_continuous(
      labels=as.character(unique(data$no_active_setts_in_fields)), 
      breaks=unique(data$no_active_setts_in_fields)
    ) +
    labs(x='# Active Settlements', y='Observed Signs Rate (w/ Sample Size)') +
    theme_bw()
```

### Number of cattle on the farm (no_cattle_in_buildings_yard)

There seems to be a positive relationship between the number of active 
settlements and the rate of badger signs in the yard. We may also look at the 
relationship between the number of cattle and the signs rate. To do so we will 
bin the number of cattle into 10% quantile increments and chart the rate for 
each bin.

```{r, fig.height=4}
data %>%
  mutate(cattle_bin=cut(
      no_cattle_in_buildings_yard,
      breaks=quantile(no_cattle_in_buildings_yard, (1:10)/10),
      include.lowest=TRUE
    )
  ) %>%
  group_by(cattle_bin) %>%
  summarise(
    n=n(),
    signs_rate=mean(signs_in_yard)
  ) %>%
  ggplot(aes(x=cattle_bin, y=signs_rate)) +
    geom_bar(stat='identity', color='black', fill='lightgreen') +
    geom_text(aes(label=n), vjust=-0.25) +
    scale_x_discrete(guide=guide_axis(angle=45)) +
    labs(x='# Cattle', y='Observed Signs Rate (w/ Sample Size)') +
    theme_bw()
```

Again, there seems to be a slight positive relationship between the number of 
cattle and the rate of badger sign observation. The plot below is an alternative 
view of this relationship.

```{r, fig.height=3}
data %>%
  mutate(cattle_bin=cut_interval(no_cattle_in_buildings_yard, n=25)) %>%
  group_by(cattle_bin) %>%
  summarise(
    n=n(),
    signs_rate=mean(signs_in_yard)
  ) %>%
  ggplot(aes(x=1:length(unique(cattle_bin)), y=signs_rate)) +
    geom_point() +
    geom_smooth(method='lm') +
    scale_x_discrete(guide=guide_axis(angle=45)) +
    labs(x='# Cattle (Bin Index)', y='Observed Signs Rate (w/ Sample Size)') +
    theme_bw()
```

### predictors in number

```{r}
p1 <- ggplot(data, aes(x = as.factor(signs_in_yard), y = no_active_setts_in_fields, fill = signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard")

p2 <- ggplot(data, aes(x = as.factor(signs_in_yard), y = no_cattle_in_buildings_yard, fill = signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard")

p3 <- ggplot(data, aes(x = as.factor(signs_in_yard), y = no_setts_in_fields, fill = signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard")


p4 <- ggplot(data, aes(x = as.factor(signs_in_yard), y = no_buildings, fill = signs_in_yard)) + 
  geom_boxplot() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard")

grid.arrange(p1, p2, p3, p4, nrow =2)

```

### Other predictors in 0/1

We also have several indicator variables to consider. To investigate these, we 
can look at the accuracy in predicting the response using each indicator as a 
sole predictor.

```{r}
## maybe add the plots to appendix
ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("accessible_cattle_house_present", scales = "fixed") +
  ggtitle("Sings in Yead vs. accessible_cattle_house_present") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("accessible_feed_present", scales = "fixed") +
  ggtitle("Sings in Yead vs. accessible_feed_present") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("grass_silage", scales = "fixed") +
  ggtitle("Sings in Yead vs. grass_silage") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("cereal_silage", scales = "fixed") +
  ggtitle("Sings in Yead vs. cereal_silage") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("hay_straw", scales = "fixed") +
  ggtitle("Sings in Yead vs. hay_straw") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("cereal_grains", scales = "fixed") +
  ggtitle("Sings in Yead vs. cereal_grains") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("concentrates", scales = "fixed") +
  ggtitle("Sings in Yead vs. concentrates") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("proteinblocks", scales = "fixed") +
  ggtitle("Sings in Yead vs. proteinblocks") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("sugarbeet", scales = "fixed") +
  ggtitle("Sings in Yead vs. sugarbeet") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("vegetables", scales = "fixed") +
  ggtitle("Sings in Yead vs. vegetables") +
  theme(plot.title = element_text(hjust = 0.5))

ggplot(data, aes(x = as.factor(signs_in_yard))) + 
  geom_bar() + 
  theme(legend.position = "none") + 
  labs(x = "Signs in Yard") +
  facet_wrap("molasses", scales = "fixed") +
  ggtitle("Sings in Yead vs. molasses") +
  theme(plot.title = element_text(hjust = 0.5))
```


```{r}
data %>%
  select(accessible_cattle_house_present:molasses) %>%
  sapply(., function(x) mean(x==data$signs_in_yard)) %>%
  enframe(name='Indicator', value='Accuracy') %>%
  kable(digits=4) %>%
  kable_classic(full_width=FALSE, latex_options='HOLD_position') %>%
  row_spec(c(2,8:10), bold=TRUE)
```

```{r}
confusionMatrix(
  factor(data$proteinblocks), 
  factor(data$signs_in_yard)
)
```

Note: accuracy is the proportion of the data that are predicted correctly.
The accuracy is good for some indicators because most observations are 0 for the 
response. The confusion matrix shows that the indicators do not have as much 
predictive power as it may seem from the accuracy alone.

### Year and season

Finally, we may look at the signs rate for each year and season combination.

```{r, fig.height=3}
data %>%
  mutate(year_season=paste0(year, '.', season)) %>%
  group_by(year_season) %>%
  summarise(
    n=n(),
    signs_rate=mean(signs_in_yard)
  ) %>%
  ggplot(aes(x=year_season, y=signs_rate)) +
    geom_bar(stat='identity', color='black', fill='plum2') +
    geom_text(aes(label=n), vjust=-0.25) +
    labs(x='Year.Season', y='Observed Signs Rate (w/ Sample Size)') +
    theme_bw()
```

2003 and 2005 seem to have similar rates, but 2004 may have an appreciably 
lower rate of badger sign observations.








```{r}
# make relevant variables into factors
model_data <- data
model_data[, c(1, 2, 10:21)] <- lapply(data[, c(1, 2, 10:21)] , factor)

model <- glmer(
  signs_in_yard ~ no_active_setts_in_fields + no_cattle_in_buildings_yard + year + (1 | farm_code_numeric),
  family='binomial',
  control=glmerControl(optimizer = "bobyqa"),
  data=model_data
)

summary(model)
dotplot(ranef(model))
```


Notes from TA:
can ignore interaction terma
Step-forward selection
logistic regression (binary response)
Might not be good to incorporate time as a variable in model (if we take farm as the group)
random intercept by farm
ICC for farms (obs were taken over time, so answers question of corr over time)
Not required to do model diagnostics


```{r}
model2 <- glmer(
  signs_in_yard ~ no_active_setts_in_fields + no_cattle_in_buildings_yard + (1 | farm_code_numeric),
  family='binomial',
  control=glmerControl(optimizer = "bobyqa"),
  data=model_data
)

summary(model2)

```


* Intercept: We can expect odds of the presence of badger activity in the farmyard decrease by 99.5%  ($1-e^{-5.227} \approx  99.5%$), if there is no settlements in the field and there is no cattles in the farm.

* Holding other variables as constants, in general,1 unit increase in the number of active settlements in the field, we expect the odds of the presence of signs of badgers in the farmyard to increase by 61.1%  ($e^{0.477}3 -1 \approx  61.1%$).

* Holding other variables as constants, in general,1 unit increase in the number of cattles in the farm, we expect the odds of the presence of signs of badgers in the farmyard to increase by 4.6%  ($e^{0.0046} -1 \approx  4.6%$).





```{r}

dotplot(ranef(model2))
```

## Research Question

1) What factors are relate to presence of badger activity in the farmyard?
2) Estimate the correlation over time in badger activity
3) Farm-specific heterogeneity in the tendency to have badger activity


